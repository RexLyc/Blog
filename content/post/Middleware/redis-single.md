---
title: "Redis：单机数据库"
date: 2022-03-18T22:17:17+08:00
categories:
- 计算机科学与技术
- 中间件
tags:
- 中间件
- 施工中
thumbnailImagePosition: left
thumbnailImage: /images/thumbnail/redis.jpg
---
单机数据库是Redis的基础形式。本章讲解相关概念和原理。
<!--more-->
# 数据库基本能力
```c
// 数据库
struct redisDb {
    // 数据库键空间，存储所有键值对儿
    dict *dict;
    // 过期时间
    dict *expires;
}
// 服务器数据库
struct redisServer {
    // 保存服务器中的所有数据库
    redisDb *db;
    // 服务器数据库数量
    int dbnum;
}
// 客户端数据库
struct redisClient {
    // 当前正使用的数据库
    redisDb *db;
}
```
1. 创建：
    - 根据服务器配置，创建若干数据库，默认是16个。
1. 键空间：
    - 数据库键空间的键就是用户存储值到数据库时用的键，每一个键就是一个字符串对象
    - 键空间的值就是用户存储在数据库中的值，可以是字符串对象、列表对象等等
    - 大部分命令都会作用于键空间（或者经过键空间）：添加、删除、更新、取值
    - 键空间的维护操作：
        - 访存键均会进行命中（hit）和不命中（miss）的累计计算
        - 成功读取一个键回更新键的LRU（最后一次使用）时间，可用于计算键的空闲时间
        - 如果访问时发现键过期，则会直接删除
        - 如果有客户端WATCH一个键，则该键更新后会被标记为脏，让后续事务程序注意到修改
        - 键更新后会将dirty计数增1，用以触发服务器的持久化和复制操作
        - 如果有通知功能，键更新后还会进行通知发送
1. 键的生存周期：
    - 生存时间：Time To Live（TTL），在经过该时间后，服务器会删除生存时间归0的键。
    - 过期时间：Expire Time，在到达该时间点时，服务器删除该键。时间戳使用UNIX时间戳。
    - 过期时间的保存：实际上所有的生存时间、过期时间最终都可以用一个过期时间戳（毫秒）进行表示。即字典expires。过期字典的键和键空间的键会共享同一个键对象。
    - 清除过期时间：服务器查找过期字典中的指定键，移除键和值之间在过期字典中的关联。
1. 过期键的删除策略：
    - 主动删除策略
        - 定时删除：设置过期时间的同时设置定时器，准时删除。对CPU不友好。且Redis中的时间事件由无序链表实现，查找事件的复杂度为$O(N)$。
        - 定期删除：定期检车数据库中的键并进行删除。对CPU、内存性能进行平衡的方案。但也需要合理配置删除频率和删除策略。算法将会定期，随机选择一定数量的键，检查并清理。
    - 被动删除策略
        - 惰性删除：下次访问时检查并删除。对内存不友好。
1. 过期键和持久化
    - 创建新RDB文件时，所有过期键均不会被保存。
    - 加载RDB文件时，主服务器会直接抛弃过期键，从服务器不会（但随后主从同步还是会被删除）
    - AOF持久化模式下，只有当过期键确实被删除时，才会进行DEL命令的记录。AOF重写也不会记录和过期键有关的操作。
    - 复制模式下，**主服务器控制**从服务器上过期键的删除，而不是连接到从服务器的客户端（即使接收到命令，也不会去删除）。未删除时，该过期键仍然能够被查询返回。

# 订阅和通知
1. 键空间通知（key space notification）
1. 键事件通知（key event notification）

# 数据库命令
1. SELECT X：选择第X个数据库
1. EXPIRE KEY SEC：设置生存时间（秒）
1. PEXPIRE KEY MSEC：设置生存时间（毫秒）
1. EXPIREAT KEY TIMESTAMP：设置过期时间戳（秒）
1. PEXPIREAT KEY TIMESTAMP：设置过期时间戳（毫秒）
1. TTL/PTTL KEY：查询一个键距离被删还有多长时间
1. PERSIST KEY：清除过期时间
1. FLUSHDB：强制清除数据库全部键值